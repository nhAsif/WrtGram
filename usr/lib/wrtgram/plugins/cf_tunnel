#!/bin/sh

LOG_FILE="/tmp/cf_tunnel.log"
PID_FILE="/tmp/cf_tunnel.pid"

DEFAULT_PORT=80
PORT=${1:-$DEFAULT_PORT} # Use $1 if provided, otherwise default to 80

# Validate port number
if ! expr "$PORT" : '[0-9]*$' > /dev/null || [ "$PORT" -lt 1 ] || [ "$PORT" -gt 65535 ]; then
    echo "Invalid port number: $PORT. Please provide a number between 1 and 65535."
    exit 1
fi

# If tunnel is running, just print the URL
if [ -f "$PID_FILE" ] && ps -p "$(cat "$PID_FILE")" > /dev/null; then
    URL=$(grep -o 'https://[a-zA-Z0-9-]\+\.trycloudflare\.com' "$LOG_FILE" | head -n 1)
    if [ -n "$URL" ]; then
        echo "$URL"
        exit 0
    fi
fi

# Start a new tunnel with the specified port
cloudflared tunnel --url "http://localhost:$PORT" --protocol=http2 > "$LOG_FILE" 2>&1 &
echo $! > "$PID_FILE"

# Poll for the URL
for i in $(seq 15); do
    URL=$(grep -o 'https://[a-zA-Z0-9-]\+\.trycloudflare\.com' "$LOG_FILE" | head -n 1)
    if [ -n "$URL" ]; then
        echo "$URL"
        exit 0
    fi
    sleep 1
done

# Cleanup on failure
echo "Failed to start tunnel on port $PORT."
kill "$(cat "$PID_FILE")"
rm "$PID_FILE"
exit 1
